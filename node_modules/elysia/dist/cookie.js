// @ts-ignore
import{parse as t}from"cookie";import{unsignCookie as e}from"./utils";import{InvalidCookieSignature as r}from"./error";export class Cookie{_value;property;name;setter;constructor(t,e={}){this._value=t,this.property=e}get(){return this._value}get value(){return this._value}set value(t){if("object"==typeof t){if(JSON.stringify(this.value)===JSON.stringify(t))return}else if(this.value===t)return;this._value=t,this.sync()}add(t){let e=Object.assign(this.property,"function"==typeof t?t(Object.assign(this.property,this.value)):t);return"value"in e&&(this._value=e.value,delete e.value),this.property=e,this.sync()}set(t){let e="function"==typeof t?t(Object.assign(this.property,this.value)):t;return"value"in e&&(this._value=e.value,delete e.value),this.property=e,this.sync()}remove(){void 0!==this.value&&this.set({value:"",expires:new Date})}get domain(){return this.property.domain}set domain(t){// @ts-ignore
this.property.domain!==t&&(// @ts-ignore
this.property.domain=t,this.sync())}get expires(){return this.property.expires}set expires(t){// @ts-ignore
this.property.expires?.getTime()!==t?.getTime()&&(// @ts-ignore
this.property.expires=t,this.sync())}get httpOnly(){return this.property.httpOnly}set httpOnly(t){// @ts-ignore
this.property.domain!==t&&(// @ts-ignore
this.property.httpOnly=t,this.sync())}get maxAge(){return this.property.maxAge}set maxAge(t){// @ts-ignore
this.property.maxAge!==t&&(// @ts-ignore
this.property.maxAge=t,this.sync())}get path(){return this.property.path}set path(t){// @ts-ignore
this.property.path!==t&&(// @ts-ignore
this.property.path=t,this.sync())}get priority(){return this.property.priority}set priority(t){// @ts-ignore
this.property.priority!==t&&(// @ts-ignore
this.property.priority=t,this.sync())}get sameSite(){return this.property.sameSite}set sameSite(t){// @ts-ignore
this.property.sameSite!==t&&(// @ts-ignore
this.property.sameSite=t,this.sync())}get secure(){return this.property.secure}set secure(t){// @ts-ignore
this.property.secure!==t&&(// @ts-ignore
this.property.secure=t,this.sync())}toString(){return"object"==typeof this.value?JSON.stringify(this.value):this.value?.toString()??""}sync(){return this.name&&this.setter&&(this.setter.cookie?this.setter.cookie[this.name]=Object.assign(this.property,{value:this.toString()}):this.setter.cookie={[this.name]:Object.assign(this.property,{value:this.toString()})}),this}}export const createCookieJar=(t,e,r)=>new Proxy(t,{get(t,i){if(i in t)return t[i];// @ts-ignore
    let s=new Cookie(void 0,r?{...r}:void 0);// @ts-ignore
    return(// @ts-ignore
    s.setter=e,s.name=i,s)},set:(t,r,i)=>i instanceof Cookie&&(e.cookie||(e.cookie={}),// @ts-ignore
        i.setter=e,i.name=r,// @ts-ignore
        i.sync(),t[r]=i,!0)});export const parseCookie=async(i,s,{secret:o,sign:p,...n}={})=>{if(!s)return createCookieJar({},i,n);let a={},h="string"==typeof o;p&&!0!==p&&!Array.isArray(p)&&(p=[p]);let y=Object.keys(t(s));for(let u=0;u<y.length;u++){let l=y[u],c=t(s)[l];if(!0===p||p?.includes(l)){if(!o)throw Error("No secret is provided to cookie plugin");if(h)// @ts-ignore
{if(!1===// @ts-ignore
(c=await e(c,o)))throw new r(l)}else{let t=!0;for(let r=0;r<o.length;r++){let i=await e(c,o[r]);if(!1!==i){c=i,t=!1;break}}if(t)throw new r(l)}}if(void 0===c)continue;let g=c.charCodeAt(0);if(123===g||91===g)try{let t=new Cookie(JSON.parse(c));// @ts-ignore
t.setter=i,t.name=l,a[l]=t;continue}catch{// Not empty
}Number.isNaN(+c)?"true"===c?c=!0:"false"===c&&(c=!1):c=+c;let m=new Cookie(c,n);// @ts-ignore
m.setter=i,m.name=l,a[l]=m}return createCookieJar(a,i)};